<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cat Face ID â€” Mobile</title>
  <style>
    :root { --green:#6aa66a; --dark:#2f5030; --bg:#f4fff1; }
    html,body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;color:#1a1a1a}
    .wrap{max-width:480px;margin:0 auto;padding:16px 16px 80px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header h1{font-size:18px;margin:0;color:var(--dark)}
    .api{font-size:12px;opacity:.8;word-break:break-all}
    .known{margin-top:6px;font-size:12px;color:#2b5b2b}
    .cam-box{position:relative;background:#000;border-radius:12px;overflow:hidden;aspect-ratio:3/4}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    canvas.overlay{pointer-events:none}
    .btns{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    button{flex:1 1 120px;border:0;border-radius:10px;padding:12px 14px;font-weight:700;background:var(--green);color:#fff;cursor:pointer}
    button.secondary{background:#e9f6e9;color:#2b5b2b;border:1px solid #b9e0b9}
    button:disabled{opacity:.6;cursor:not-allowed}
    .panel{background:#fff;border:1px solid #e6efe6;border-radius:12px;padding:12px}
    .row{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-top:1px dashed #d9ead9}
    .row:first-child{border-top:0}
    .tag{font-size:12px;color:#2b5b2b;background:#e9f6e9;border:1px solid #b9e0b9;border-radius:999px;padding:2px 8px}
    .foot{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,transparent,rgba(244,255,241,.9) 20%,rgba(244,255,241,1) 60%);padding:8px 12px}
    .msg{font-size:12px;color:#4a4a4a}
    input[type="file"]{display:none}
    .small{font-size:12px;opacity:.8}
    .livebar{display:flex;align-items:center;gap:10px;margin-top:-4px}
    .livebar label{font-size:12px;color:#2b5b2b}
    .livebar input[type="range"]{flex:1}
    /* Modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:16px 18px;max-width:90vw}
    .modal h3{margin:0 0 8px;font-size:16px;color:var(--dark)}
    .modal .names{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:#e9f6e9;border:1px solid #b9e0b9;color:#2b5b2b;border-radius:999px;padding:6px 10px;font-weight:700}
    .modal .btns{margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ± Cat Face ID</h1>
        <div class="known">å·²çŸ¥è²“ï¼š<span id="knownCats" class="small">è¼‰å…¥ä¸­â€¦</span></div>
      </div>
      <div class="api">APIï¼š<span id="api-url" class="small"></span></div>
    </header>

    <!-- æ”å½±æ©Ÿå€ -->
    <div class="cam-box">
      <video id="preview" playsinline autoplay muted></video>
      <canvas id="overlay" class="overlay"></canvas>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="btns">
      <button id="btnStart" type="button">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnSwap" class="secondary" type="button">åˆ‡æ›é¡é ­</button>
      <button id="btnShot" type="button">æˆªåœ– & è¾¨è­˜</button>
      <button id="btnLive" type="button" class="secondary">å³æ™‚è¾¨è­˜</button>
      <label class="secondary" style="flex:1 1 120px;display:flex;align-items:center;justify-content:center;gap:6px;cursor:pointer">
        <input id="fileInput" type="file" accept="image/*" capture="environment" />
        ä¸Šå‚³ / é–‹ç›¸æ©Ÿ
      </label>
    </div>

    <!-- å³æ™‚é »ç‡æ§åˆ¶ -->
    <div class="livebar">
      <label for="liveRate">é »ç‡(ms)ï¼š</label>
      <input id="liveRate" type="range" min="300" max="2000" step="100" value="800" />
      <span id="liveRateVal" class="small">800</span>
    </div>

    <!-- çµæœé¢æ¿ï¼ˆä¿ç•™æ¸…å–®ï¼‰ -->
    <section class="panel" id="resultPanel" hidden>
      <div id="resultList"></div>
    </section>

    <p class="small">æç¤ºï¼šæ‰‹æ©Ÿå¿…é ˆä½¿ç”¨ HTTPSï¼ˆæˆ– localhostï¼‰æ‰èƒ½å•Ÿå‹•ç›¸æ©Ÿã€‚</p>
  </div>

  <div class="foot"><div class="msg" id="status">ç‹€æ…‹ï¼šå¾…æ©Ÿ</div></div>

  <!-- Modalï¼ˆæ‡¸æµ®è¦–çª—ï¼‰ -->
  <div id="backdrop" class="backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>è¾¨è­˜çµæœ</h3>
      <div id="modalNames" class="names"></div>
      <div class="btns">
        <button id="modalClose" type="button" class="secondary">é—œé–‰</button>
      </div>
    </div>
  </div>

<script>
/** ğŸ”§ æŠŠé€™å€‹æ”¹æˆä½ çš„å¾Œç«¯ç¶²åŸŸ */
const API_URL = 'https://cat-face-id-api.onrender.com/predict';
document.getElementById('api-url').textContent = API_URL;

const video = document.getElementById('preview');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const statusEl = document.getElementById('status');
const btnStart = document.getElementById('btnStart');
const btnSwap  = document.getElementById('btnSwap');
const btnShot  = document.getElementById('btnShot');
const btnLive  = document.getElementById('btnLive');
const fileInput = document.getElementById('fileInput');
const resultPanel = document.getElementById('resultPanel');
const resultList  = document.getElementById('resultList');
const liveRate = document.getElementById('liveRate');
const liveRateVal = document.getElementById('liveRateVal');
const backdrop = document.getElementById('backdrop');
const modalNames = document.getElementById('modalNames');
const modalClose = document.getElementById('modalClose');
const knownCats = document.getElementById('knownCats');

let usingBack = true;
let currentStream = null;
let liveTimer = null;
let inflight = false;
let baseInterval = Number(liveRate.value);
let backoff = 0;
const maxBackoffMs = 3000;
const toJpegQuality = 0.9;

function setStatus(s){ statusEl.textContent = 'ç‹€æ…‹ï¼š' + s; }
function setBusy(b){ btnShot.disabled = b; btnSwap.disabled = b; btnLive.disabled = false; }
function clearOverlay(){ ctx.clearRect(0,0,overlay.width,overlay.height); }

function resizeOverlay() {
  const rect = video.getBoundingClientRect();
  overlay.width = rect.width * devicePixelRatio;
  overlay.height = rect.height * devicePixelRatio;
  overlay.style.width = rect.width + 'px';
  overlay.style.height = rect.height + 'px';
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  clearOverlay();
}
window.addEventListener('resize', resizeOverlay);

// ç›¸æ©Ÿå•Ÿå‹•ï¼ˆA/B/C é€€é¿ï¼‰
async function startCamera() {
  try {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setStatus('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿ API'); return;
    }
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    clearOverlay();

    const a = { audio:false, video:{ facingMode:{ ideal: usingBack?'environment':'user' }, width:{ ideal:1280 }, height:{ ideal:1700 } } };
    let stream;
    try { stream = await navigator.mediaDevices.getUserMedia(a); }
    catch {
      try {
        const b = { audio:false, video:{ width:{ ideal:1280 }, height:{ ideal:1700 } } };
        stream = await navigator.mediaDevices.getUserMedia(b);
        setStatus('ç›¸æ©Ÿå•Ÿå‹•ï¼ˆé è¨­é¡é ­ï¼‰');
      } catch {
        stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        setStatus('ç›¸æ©Ÿå•Ÿå‹•ï¼ˆæœ€å°åƒæ•¸ï¼‰');
      }
    }
    currentStream = stream;
    video.srcObject = stream;
    await video.play();

    await new Promise(res => {
      if (video.readyState >= 1) return res();
      video.onloadedmetadata = () => res();
      setTimeout(res, 1200);
    });

    resizeOverlay();
    setStatus('ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ');
  } catch (err) {
    console.warn(err);
    alert('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèª HTTPS èˆ‡æ¬Šé™ã€‚');
  }
}

// æ“·å–å½±æ ¼
async function grabVideoFrameBlob() {
  if (!video.videoWidth) return null;
  const W = video.videoWidth, H = video.videoHeight;
  const tmp = document.createElement('canvas');
  tmp.width = W; tmp.height = H;
  const tctx = tmp.getContext('2d');
  tctx.drawImage(video, 0, 0, W, H);
  const blob = await new Promise(res => tmp.toBlob(res, 'image/jpeg', toJpegQuality));
  return { blob, meta: { sourceW: W, sourceH: H } };
}

// å‘¼å« API
async function sendToAPI(imageBlob){
  const fd = new FormData();
  fd.append('file', imageBlob, 'shot.jpg');
  const r = await fetch(API_URL, { method: 'POST', body: fd });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return await r.json();
}

// Overlay æ¨™ç±¤
function drawLabel(ctx, text, x, y) {
  ctx.font = 'bold 14px system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif';
  const padX = 6, padY = 4;
  const w = ctx.measureText(text).width + padX*2;
  const h = 16 + padY*2;
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0.55)';
  ctx.fillRect(x, y - h, w, h);
  ctx.fillStyle = '#fff';
  ctx.fillText(text, x + padX, y - padY);
  ctx.restore();
}

// åœ¨ç›¸æ©Ÿç•«é¢ä¸Šç•«æ¡†ï¼‹åå­—ï¼ˆå³æ™‚/ä¸Šå‚³éƒ½ç”¨ï¼‰
function renderOverlay(res, meta){
  resultPanel.hidden = false;
  resultList.innerHTML = '';
  clearOverlay();

  const dispW = video.getBoundingClientRect().width;
  const dispH = video.getBoundingClientRect().height;
  const scaleX = dispW / (res.width || meta?.sourceW || 1);
  const scaleY = dispH / (res.height || meta?.sourceH || 1);

  const boxes = res.boxes || [];
  for (const b of boxes) {
    const x = b.x * scaleX, y = b.y * scaleY, w = b.w * scaleX, h = b.h * scaleY;
    const isUnknown = (b.name || 'Unknown') === 'Unknown';
    ctx.save();
    ctx.lineWidth = 3;
    ctx.strokeStyle = isUnknown ? '#e53935' : '#00c853';
    ctx.strokeRect(x, y, w, h);
    const label = `${b.name || 'Unknown'} (${(b.proba ?? 0).toFixed(2)})`;
    drawLabel(ctx, label, x + 4, Math.max(y - 6, 18));
    ctx.restore();

    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `<div><div><strong>${b.name || 'Unknown'}</strong></div>
      <div class="small">ä¿¡å¿ƒï¼š${(b.proba ?? 0).toFixed(2)}</div></div>
      <div class="tag">${Math.round(b.w)}Ã—${Math.round(b.h)}</div>`;
    resultList.appendChild(row);
  }
  if (boxes.length === 0) resultList.innerHTML = `<div class="row"><em>æ²’æœ‰åµæ¸¬åˆ°è²“è‡‰</em></div>`;
}

// Modalï¼šé¡¯ç¤ºåå­—
function showNamesModal(names){
  const box = modalNames;
  box.innerHTML = '';
  if (names.length === 0) {
    box.innerHTML = '<span class="chip">æ²’æœ‰åµæ¸¬åˆ°è²“è‡‰</span>';
  } else {
    names.forEach(n => {
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = n;
      box.appendChild(span);
    });
  }
  backdrop.style.display = 'flex';
}
function closeModal(){ backdrop.style.display = 'none'; }
modalClose.addEventListener('click', closeModal);
backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });

// æˆªåœ– & è¾¨è­˜ï¼šåªé–‹ Modal é¡¯ç¤ºåå­—
async function captureAndSend() {
  if (!video.videoWidth) return;
  setBusy(true); setStatus('æ“·å–ç•«é¢ä¸­â€¦');
  try {
    const g = await grabVideoFrameBlob();
    if (!g) return;
    setStatus('ä¸Šå‚³è¾¨è­˜ä¸­â€¦');
    const data = await sendToAPI(g.blob);
    const names = (data.boxes || []).map(b => b.name || 'Unknown');
    showNamesModal(names);
    setStatus('å®Œæˆ');
  } catch (e) {
    console.error(e);
    alert('è¾¨è­˜å¤±æ•—ï¼š' + e.message);
    setStatus('è¾¨è­˜å¤±æ•—');
  } finally {
    setBusy(false);
  }
}

// å³æ™‚è¾¨è­˜
function currentIntervalMs(){ return Math.min(maxBackoffMs, baseInterval * (1 << backoff)); }
function scheduleNextTick(){ liveTimer = setTimeout(liveTick, currentIntervalMs()); }
async function liveTick(){
  if (!video.videoWidth) { scheduleNextTick(); return; }
  if (inflight) { scheduleNextTick(); return; }
  inflight = true;
  try {
    const g = await grabVideoFrameBlob();
    if (!g) { inflight = false; scheduleNextTick(); return; }
    const data = await sendToAPI(g.blob);
    renderOverlay(data, g.meta);
    backoff = 0;
  } catch (e) {
    console.warn('å³æ™‚è¾¨è­˜éŒ¯èª¤:', e);
    if (baseInterval * (1 << (backoff + 1)) <= maxBackoffMs) backoff++;
    setStatus('è¾¨è­˜å¤±æ•—ï¼Œé€€é¿é‡è©¦â€¦');
  } finally {
    inflight = false;
    if (liveTimer !== null) scheduleNextTick();
  }
}
function startLive(){
  if (liveTimer !== null) return;
  backoff = 0; liveTimer = 0; scheduleNextTick();
  btnLive.textContent = 'åœæ­¢å³æ™‚'; btnLive.classList.remove('secondary');
  setStatus('å³æ™‚è¾¨è­˜å•Ÿå‹•');
}
function stopLive(){
  if (liveTimer !== null) clearTimeout(liveTimer);
  liveTimer = null; inflight = false; backoff = 0;
  btnLive.textContent = 'å³æ™‚è¾¨è­˜'; btnLive.classList.add('secondary');
  setStatus('å³æ™‚è¾¨è­˜å·²åœæ­¢');
}

// äº‹ä»¶
btnStart.addEventListener('click', async () => { setStatus('å˜—è©¦é–‹å•Ÿç›¸æ©Ÿâ€¦'); await startCamera(); });
btnSwap.addEventListener('click', async () => { usingBack = !usingBack; await startCamera(); });
btnShot.addEventListener('click', captureAndSend);
btnLive.addEventListener('click', () => { if (liveTimer === null) startLive(); else stopLive(); });
fileInput.addEventListener('change', async (e) => {
  const f = e.target.files?.[0]; if (!f) return;
  setBusy(true);
  try {
    const data = await sendToAPI(f);
    renderOverlay(data, { sourceW: video.videoWidth || 0, sourceH: video.videoHeight || 0 });
    setStatus('å®Œæˆ');
  } catch (e2) {
    console.error(e2); alert('è¾¨è­˜å¤±æ•—ï¼š' + e2.message);
  } finally { setBusy(false); fileInput.value=''; }
});
liveRate.addEventListener('input', () => { baseInterval = Number(liveRate.value); liveRateVal.textContent = baseInterval; });

// å•Ÿå‹•ï¼šéœ€è¦ HTTPS æˆ– localhost
if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1'){
  setStatus('å¾…æ©Ÿï¼šè«‹é»ã€Œå•Ÿå‹•ç›¸æ©Ÿã€');
} else {
  setStatus('éœ€ HTTPS æˆ– localhost æ‰èƒ½å•Ÿå‹•ç›¸æ©Ÿ');
}

// é¡¯ç¤ºæ¨¡å‹å·²çŸ¥è²“å
(async () => {
  try {
    const labelsURL = API_URL.replace('/predict','/labels');
    const r = await fetch(labelsURL);
    if (!r.ok) throw new Error('labels fetch failed');
    const j = await r.json();
    knownCats.textContent = (j.labels || []).join('ã€') || 'ï¼ˆç„¡ï¼‰';
  } catch {
    knownCats.textContent = 'ç„¡æ³•å–å¾—';
  }
})();
</script>
</body>
</html>
