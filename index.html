<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cat Face ID — Mobile</title>
  <style>
    :root { --green:#6aa66a; --dark:#2f5030; --bg:#f4fff1; }
    html,body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;color:#1a1a1a}
    .wrap{max-width:480px;margin:0 auto;padding:16px 16px 80px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    header h1{font-size:18px;margin:0;color:var(--dark)}
    .api{font-size:12px;opacity:.8;word-break:break-all}
    .cam-box{position:relative;background:#000;border-radius:12px;overflow:hidden;aspect-ratio:3/4}
    video,canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    canvas.overlay{pointer-events:none}
    .btns{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    button{flex:1 1 120px;border:0;border-radius:10px;padding:12px 14px;font-weight:700;background:var(--green);color:#fff}
    button.secondary{background:#e9f6e9;color:#2b5b2b;border:1px solid #b9e0b9}
    button:disabled{opacity:.6}
    .panel{background:#fff;border:1px solid #e6efe6;border-radius:12px;padding:12px}
    .row{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-top:1px dashed #d9ead9}
    .row:first-child{border-top:0}
    .tag{font-size:12px;color:#2b5b2b;background:#e9f6e9;border:1px solid #b9e0b9;border-radius:999px;padding:2px 8px}
    .foot{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,transparent,rgba(244,255,241,.9) 20%,rgba(244,255,241,1) 60%);padding:8px 12px}
    .msg{font-size:12px;color:#4a4a4a}
    input[type="file"]{display:none}
    .small{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>🐱 Cat Face ID</h1>
      <div class="api">
        API：<span id="api-url" class="small"></span>
      </div>
    </header>

    <!-- 攝影機區 -->
    <div class="cam-box">
      <video id="preview" playsinline autoplay muted></video>
      <canvas id="overlay" class="overlay"></canvas>
    </div>

    <!-- 操作按鈕 -->
    <div class="btns">
      <button id="btnSwap" class="secondary" type="button">切換鏡頭</button>
      <button id="btnShot" type="button">截圖 & 辨識</button>
      <label class="secondary" style="flex:1 1 120px;display:flex;align-items:center;justify-content:center;gap:6px;cursor:pointer">
        <input id="fileInput" type="file" accept="image/*" />
        上傳圖片
      </label>
    </div>

    <!-- 結果面板 -->
    <section class="panel" id="resultPanel" hidden>
      <div id="resultList"></div>
    </section>

    <p class="small">提示：行動裝置必須透過 HTTPS 網域（或在電腦 <code>localhost</code>）才能開啟相機。</p>

  </div>

  <div class="foot">
    <div class="msg" id="status">狀態：待機</div>
  </div>

<script>
/** 🔧 改成你部署的 API URL（FastAPI /predict 端點） */
const API_URL = 'https://http://127.0.0.1:8000/predict'; // 例如：https://api-server-1-dfq6.onrender.com/predict
document.getElementById('api-url').textContent = API_URL;

// 影像與 overlay
const video = document.getElementById('preview');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const statusEl = document.getElementById('status');
const btnSwap = document.getElementById('btnSwap');
const btnShot = document.getElementById('btnShot');
const fileInput = document.getElementById('fileInput');
const resultPanel = document.getElementById('resultPanel');
const resultList = document.getElementById('resultList');

let usingBack = true;
let currentStream = null;

// 啟動相機
async function startCamera() {
  try {
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    const constraints = {
      audio: false,
      video: {
        facingMode: usingBack ? { exact: 'environment' } : 'user',
        width: { ideal: 1280 }, height: { ideal: 1700 }
      }
    };
    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = currentStream;
    await video.play();
    resizeOverlay();
    setStatus('相機已啟動');
  } catch (err) {
    // 有些裝置不支援 exact: 'environment'，退而求其次
    if (usingBack) {
      try {
        const fallback = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        currentStream = fallback; video.srcObject = fallback; await video.play(); resizeOverlay();
        setStatus('相機啟動（後鏡頭不支援，已改用預設）');
      } catch (e2) {
        setStatus('相機啟動失敗：' + e2.message);
        alert('需要相機權限或 HTTPS 網域才能使用相機。');
      }
    } else {
      setStatus('相機啟動失敗：' + err.message);
    }
  }
}

function resizeOverlay() {
  const rect = video.getBoundingClientRect();
  overlay.width = rect.width * devicePixelRatio;
  overlay.height = rect.height * devicePixelRatio;
  overlay.style.width = rect.width + 'px';
  overlay.style.height = rect.height + 'px';
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  clearOverlay();
}
function clearOverlay(){ ctx.clearRect(0,0,overlay.width,overlay.height); }

window.addEventListener('resize', resizeOverlay);

// 截圖→送後端
async function captureAndSend() {
  if (!video.videoWidth) return;
  setBusy(true); clearOverlay(); setStatus('擷取畫面中…');

  // 把 video 畫到暫存 canvas
  const tmp = document.createElement('canvas');
  const W = video.videoWidth, H = video.videoHeight;
  tmp.width = W; tmp.height = H;
  const tctx = tmp.getContext('2d');
  tctx.drawImage(video, 0, 0, W, H);

  // 壓縮成 JPEG blob
  const blob = await new Promise(res => tmp.toBlob(res, 'image/jpeg', 0.9));
  await sendToAPI(blob, { sourceW: W, sourceH: H });
}

async function sendToAPI(imageBlob, meta){
  try {
    setStatus('上傳辨識中…');
    const fd = new FormData();
    fd.append('file', imageBlob, 'shot.jpg');

    const r = await fetch(API_URL, { method: 'POST', body: fd });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();

    // 期望回傳格式：
    // { boxes: [ {x,y,w,h,name,proba}... ], width: 原圖寬, height: 原圖高 }
    renderResult(data, meta);
    setStatus('完成');
  } catch (e) {
    console.error(e);
    setStatus('辨識失敗：' + e.message);
    alert('辨識失敗：' + e.message);
  } finally {
    setBusy(false);
  }
}

function renderResult(res, meta){
  resultPanel.hidden = false;
  resultList.innerHTML = '';

  // 畫方框（依原圖→前端顯示比例換算）
  clearOverlay();
  const dispW = video.getBoundingClientRect().width;
  const dispH = video.getBoundingClientRect().height;
  const scaleX = dispW / (res.width || meta.sourceW);
  const scaleY = dispH / (res.height || meta.sourceH);

  (res.boxes || []).forEach(b => {
    const x = b.x * scaleX;
    const y = b.y * scaleY;
    const w = b.w * scaleX;
    const h = b.h * scaleY;
    const isUnknown = (b.name || 'Unknown') === 'Unknown';

    ctx.strokeStyle = isUnknown ? 'red' : '#00c853';
    ctx.lineWidth = 3;
    ctx.strokeRect(x, y, w, h);
    ctx.fillStyle = ctx.strokeStyle;
    ctx.font = 'bold 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
    const label = `${b.name || 'Unknown'} (${(b.proba ?? 0).toFixed(2)})`;
    ctx.fillText(label, x + 6, Math.max(14, y - 6));

    // 列在結果清單
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div>
        <div><strong>${b.name || 'Unknown'}</strong></div>
        <div class="small">信心：${(b.proba ?? 0).toFixed(2)}</div>
      </div>
      <div class="tag">${Math.round(b.w)}×${Math.round(b.h)}</div>
    `;
    resultList.appendChild(row);
  });

  if (!res.boxes || res.boxes.length === 0){
    resultList.innerHTML = `<div class="row"><em>沒有偵測到貓臉</em></div>`;
  }
}

btnSwap.addEventListener('click', async () => {
  usingBack = !usingBack;
  await startCamera();
});
btnShot.addEventListener('click', captureAndSend);

fileInput.addEventListener('change', async (e) => {
  const f = e.target.files?.[0];
  if (!f) return;
  setBusy(true); clearOverlay(); setStatus('上傳辨識中…');
  await sendToAPI(f, { sourceW: video.videoWidth || 0, sourceH: video.videoHeight || 0 });
});

function setBusy(b){
  btnShot.disabled = b; btnSwap.disabled = b;
}

function setStatus(s){ statusEl.textContent = '狀態：' + s; }

// 啟動
if (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1'){
  startCamera();
} else {
  setStatus('需 HTTPS 或 localhost 才能啟動相機');
}
</script>
</body>
</html>
